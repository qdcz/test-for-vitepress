<!DOCTYPE html>
<html lang="en-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Stream | 澜漾</title>
    <meta name="description" content="广天下之广,深天下之深">
    <link rel="stylesheet" href="/assets/style.106e1cbf.css">
    <link rel="modulepreload" href="/assets/Home.f981db03.js">
    <link rel="modulepreload" href="/assets/app.63212dfc.js">
    <link rel="modulepreload" href="/assets/service_NodeJs_stream.md.55a82ef5.lean.js">
    
    <meta name="twitter:title" content="Stream | 澜漾">
  <meta property="og:title" content="Stream | 澜漾">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme"><header class="nav-bar" data-v-675d8756><div class="sidebar-button" data-v-675d8756><svg class="icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z" class></path></svg></div><a class="nav-bar-title" href="/" aria-label="澜漾, back to home" data-v-675d8756 data-v-cc01ef16><img class="logo" src="/logo2.jpg" alt="Logo" data-v-cc01ef16> 澜漾</a><div class="flex-grow" data-v-675d8756></div><div class="nav" data-v-675d8756><nav class="nav-links" data-v-675d8756 data-v-eab3edfe><!--[--><div class="item" data-v-eab3edfe><div class="nav-link" data-v-eab3edfe data-v-b8818f8c><a class="item" href="/" data-v-b8818f8c>首页 <!----></a></div></div><div class="item" data-v-eab3edfe><div class="nav-link" data-v-eab3edfe data-v-b8818f8c><a class="item" href="/home/home" data-v-b8818f8c>码上行动 <!----></a></div></div><div class="item" data-v-eab3edfe><div class="nav-link" data-v-eab3edfe data-v-b8818f8c><a class="item" href="/IDEShortcutKey/WebStorm" data-v-b8818f8c>编辑器快捷键 <!----></a></div></div><div class="item" data-v-eab3edfe><div class="nav-link" data-v-eab3edfe data-v-b8818f8c><a class="item" href="/npmPackage/index" data-v-b8818f8c>npm包备注 <!----></a></div></div><div class="item" data-v-eab3edfe><div class="nav-link" data-v-eab3edfe data-v-b8818f8c><a class="item" href="/environmentConstruction/index" data-v-b8818f8c>环境搭建 <!----></a></div></div><div class="item" data-v-eab3edfe><div class="nav-link" data-v-eab3edfe data-v-b8818f8c><a class="item" href="/windowSystem/index" data-v-b8818f8c>windowSkills <!----></a></div></div><div class="item" data-v-eab3edfe><div class="nav-link" data-v-eab3edfe data-v-b8818f8c><a class="item" href="/service/Linux/index" data-v-b8818f8c>linuxSkills <!----></a></div></div><div class="item" data-v-eab3edfe><div class="nav-link" data-v-eab3edfe data-v-b8818f8c><a class="item" href="/about/index" data-v-b8818f8c>关于 <!----></a></div></div><div class="item" data-v-eab3edfe><div class="nav-link" data-v-eab3edfe data-v-b8818f8c><a class="item" href="/concat/index" data-v-b8818f8c>友情链接 <!----></a></div></div><div class="item" data-v-eab3edfe><div class="nav-link" data-v-eab3edfe data-v-b8818f8c><a class="item" href="/temporary/index" data-v-b8818f8c>临时存储 <!----></a></div></div><!--]--><!----><div class="item" data-v-eab3edfe><div class="nav-link" data-v-eab3edfe data-v-b8818f8c><a class="item isExternal" href="https://github.com/qdcz" target="_blank" rel="noopener noreferrer" data-v-b8818f8c>GitHub <svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15" data-v-b8818f8c><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div></div></nav></div><!--[--><!--]--></header><aside class="sidebar" data-v-83e92a68><nav class="nav-links nav" data-v-83e92a68 data-v-eab3edfe><!--[--><div class="item" data-v-eab3edfe><div class="nav-link" data-v-eab3edfe data-v-b8818f8c><a class="item" href="/" data-v-b8818f8c>首页 <!----></a></div></div><div class="item" data-v-eab3edfe><div class="nav-link" data-v-eab3edfe data-v-b8818f8c><a class="item" href="/home/home" data-v-b8818f8c>码上行动 <!----></a></div></div><div class="item" data-v-eab3edfe><div class="nav-link" data-v-eab3edfe data-v-b8818f8c><a class="item" href="/IDEShortcutKey/WebStorm" data-v-b8818f8c>编辑器快捷键 <!----></a></div></div><div class="item" data-v-eab3edfe><div class="nav-link" data-v-eab3edfe data-v-b8818f8c><a class="item" href="/npmPackage/index" data-v-b8818f8c>npm包备注 <!----></a></div></div><div class="item" data-v-eab3edfe><div class="nav-link" data-v-eab3edfe data-v-b8818f8c><a class="item" href="/environmentConstruction/index" data-v-b8818f8c>环境搭建 <!----></a></div></div><div class="item" data-v-eab3edfe><div class="nav-link" data-v-eab3edfe data-v-b8818f8c><a class="item" href="/windowSystem/index" data-v-b8818f8c>windowSkills <!----></a></div></div><div class="item" data-v-eab3edfe><div class="nav-link" data-v-eab3edfe data-v-b8818f8c><a class="item" href="/service/Linux/index" data-v-b8818f8c>linuxSkills <!----></a></div></div><div class="item" data-v-eab3edfe><div class="nav-link" data-v-eab3edfe data-v-b8818f8c><a class="item" href="/about/index" data-v-b8818f8c>关于 <!----></a></div></div><div class="item" data-v-eab3edfe><div class="nav-link" data-v-eab3edfe data-v-b8818f8c><a class="item" href="/concat/index" data-v-b8818f8c>友情链接 <!----></a></div></div><div class="item" data-v-eab3edfe><div class="nav-link" data-v-eab3edfe data-v-b8818f8c><a class="item" href="/temporary/index" data-v-b8818f8c>临时存储 <!----></a></div></div><!--]--><!----><div class="item" data-v-eab3edfe><div class="nav-link" data-v-eab3edfe data-v-b8818f8c><a class="item isExternal" href="https://github.com/qdcz" target="_blank" rel="noopener noreferrer" data-v-b8818f8c>GitHub <svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15" data-v-b8818f8c><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div></div></nav><!--[--><!--]--><ul class="sidebar-links" data-v-83e92a68><!--[--><li class="sidebar-link"><a class="sidebar-link-item" href="#概念">概念</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#对象模式">对象模式</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#缓冲">缓冲</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#可写流-writable">可写流(writable)</a><ul class="sidebar-links"><li class="sidebar-link"><a class="sidebar-link-item" href="#创建可写流">创建可写流</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#示例">示例</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#事件">事件</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#方法">方法</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#属性">属性</a><!----></li></ul></li><li class="sidebar-link"><a class="sidebar-link-item" href="#可读流-readable">可读流(readable)</a><ul class="sidebar-links"><li class="sidebar-link"><a class="sidebar-link-item" href="#两种读取模式">两种读取模式</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#三种状态">三种状态</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#选择一种接口风格">选择一种接口风格</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#创建可读流">创建可读流</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#示例-1">示例</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#事件-1">事件</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#方法-1">方法</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#属性-1">属性</a><!----></li></ul></li><li class="sidebar-link"><a class="sidebar-link-item" href="#双工流">双工流()</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#转化流">转化流</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#附表1">附表1</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#压背-backpressure">压背( Backpressure)</a><!----></li><!--]--></ul><!--[--><!--]--></aside><div class="sidebar-mask"></div><main class="page" data-v-7eddb2c4><div class="container" data-v-7eddb2c4><!--[--><!--]--><div style="position:relative;" class="content" data-v-7eddb2c4><div><h1 id="stream" tabindex="-1">Stream</h1><h2 id="概念" tabindex="-1">概念</h2><p>流(Stream) 是在 node.js 中处理数据流的抽象接口</p><p>Node.js 中有四种基本的流类型：</p><ul><li><p><a href="http://nodejs.cn/api/stream.html#class-streamwritable" target="_blank" rel="noopener noreferrer"><code>Writable</code></a>: 可以写入数据的流（例如，<a href="http://nodejs.cn/api/fs.html#fscreatewritestreampath-options" target="_blank" rel="noopener noreferrer"><code>fs.createWriteStream()</code></a>）。</p></li><li><p><a href="http://nodejs.cn/api/stream.html#class-streamreadable" target="_blank" rel="noopener noreferrer"><code>Readable</code></a>: 可以从中读取数据的流（例如，<a href="http://nodejs.cn/api/fs.html#fscreatereadstreampath-options" target="_blank" rel="noopener noreferrer"><code>fs.createReadStream()</code></a>）。</p></li><li><p><a href="http://nodejs.cn/api/stream.html#class-streamduplex" target="_blank" rel="noopener noreferrer"><code>Duplex</code></a>: <code>Readable</code> 和 <code>Writable</code> 的流（双工流）（例如，<a href="http://nodejs.cn/api/net.html#class-netsocket" target="_blank" rel="noopener noreferrer"><code>net.Socket</code></a>）。</p></li><li><p><a href="http://nodejs.cn/api/stream.html#class-streamtransform" target="_blank" rel="noopener noreferrer"><code>Transform</code></a>: 可以在写入和读取数据时修改或转换数据的 <code>Duplex</code> 流（例如，<a href="http://nodejs.cn/api/zlib.html#zlibcreatedeflateoptions" target="_blank" rel="noopener noreferrer"><code>zlib.createDeflate()</code></a>）。</p><p>转换流是基于双向流的，可以在读或者写的时候被用来更改或者转换数据。一个例子是 zlib.createGzip 使用 gzip 算法压缩数据。你可以将转换流想象成一个函数，它的输入是可写流，输出是可读流。你或许也听过将转换流成为“通过流（through streams）”。</p></li></ul><h2 id="对象模式" tabindex="-1">对象模式</h2><p>Node.js API 创建的所有流都只对字符串和 <code>Buffer</code>（或 <code>Uint8Array</code>）对象进行操作 ，</p><p>流的实例在创建流时使用 <code>objectMode</code> 选项切换到对象模式。 尝试将现有的流切换到对象模式是不安全的。</p><h2 id="缓冲" tabindex="-1">缓冲</h2><p><a href="http://nodejs.cn/api/stream.html#class-streamwritable" target="_blank" rel="noopener noreferrer"><code>Writable</code></a> 和 <a href="http://nodejs.cn/api/stream.html#class-streamreadable" target="_blank" rel="noopener noreferrer"><code>Readable</code></a> 流都将数据存储在内部缓冲区中 ，缓冲的数量取决于流的构造函数的highWaterMark选项。</p><p>对于普通流： <code>highWaterMark</code> 用于指定字节的总数</p><p>对于对象模式： <code>highWaterMark</code> 用于指定对象的总数</p><blockquote><p>当实现调用 <a href="http://nodejs.cn/api/stream.html#readablepushchunk-encoding" target="_blank" rel="noopener noreferrer"><code>stream.push(chunk)</code></a> 时，数据缓存在 <code>Readable</code> 流中。 如果流的消费者没有调用 <a href="http://nodejs.cn/api/stream.html#readablereadsize" target="_blank" rel="noopener noreferrer"><code>stream.read()</code></a>，则数据会一直驻留在内部队列中，直到被消费。</p></blockquote><h2 id="可写流-writable" tabindex="-1">可写流(writable)</h2><p>可写流是 数据写入目标的抽象</p><p>常见的可写流有：</p><ul><li>客户端上http请求、</li><li>服务器上的http响应、</li><li>文件系统写入流、</li><li>压缩流、加密流、</li><li>TCP套接字、</li><li>子进程的标准输入、</li><li>process.stdout、</li><li>process.stderr</li></ul><h3 id="创建可写流" tabindex="-1">创建可写流</h3><p><strong>createWriteStream</strong>:是fs模块的一个api，参数如下：</p><div class="language-js line-numbers-mode"><pre><code>fs<span class="token punctuation">.</span><span class="token function">createWriteStream</span><span class="token punctuation">(</span>path<span class="token punctuation">[</span><span class="token punctuation">,</span> options<span class="token punctuation">]</span><span class="token punctuation">)</span>

path <span class="token operator">&lt;</span>string<span class="token operator">&gt;</span> <span class="token operator">|</span> <span class="token operator">&lt;</span>Buffer<span class="token operator">&gt;</span> <span class="token operator">|</span> <span class="token operator">&lt;</span><span class="token constant">URL</span><span class="token operator">&gt;</span>
options <span class="token operator">&lt;</span>string<span class="token operator">&gt;</span> <span class="token operator">|</span> <span class="token operator">&lt;</span>Object<span class="token operator">&gt;</span>
    start <span class="token operator">&lt;</span>integer<span class="token operator">&gt;</span>
    flags <span class="token operator">&lt;</span>string<span class="token operator">&gt;</span> 默认值<span class="token operator">:</span> <span class="token string">&#39;w&#39;</span>。  详见下 附表<span class="token number">1</span>
    encoding <span class="token operator">&lt;</span>string<span class="token operator">&gt;</span> 默认值<span class="token operator">:</span> <span class="token string">&#39;utf8&#39;</span>
    fd <span class="token operator">&lt;</span>integer<span class="token operator">&gt;</span> <span class="token operator">|</span> <span class="token operator">&lt;</span>FileHandle<span class="token operator">&gt;</span> 默认值<span class="token operator">:</span> <span class="token keyword">null</span>
    mode <span class="token operator">&lt;</span>integer<span class="token operator">&gt;</span> 默认值<span class="token operator">:</span> <span class="token number">0o666</span>
    autoClose <span class="token operator">&lt;</span>boolean<span class="token operator">&gt;</span> 默认值<span class="token operator">:</span> <span class="token boolean">true</span>
    emitClose <span class="token operator">&lt;</span>boolean<span class="token operator">&gt;</span> 默认值<span class="token operator">:</span> <span class="token boolean">true</span>
    
    fs <span class="token operator">&lt;</span>Object<span class="token operator">&gt;</span> <span class="token operator">|</span> <span class="token operator">&lt;</span><span class="token keyword">null</span><span class="token operator">&gt;</span> 默认值<span class="token operator">:</span> <span class="token keyword">null</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><ul><li><p>path一般使用路径</p></li><li><p>start 选项，以允许在文件开头的某个位置写入数据，允许的值在 [0, Number.MAX_SAFE_INTEGER] 范围内。 修改文件而不是替换它可能需要将 flags 选项设置为 r+ 而不是默认的 w。 encoding 可以是 Buffer接受的任何一种。</p></li><li><p>autoClose 设置为 true（默认行为），则在 &#39;error&#39; 或 &#39;finish&#39; 时文件描述符将自动关闭。 如果 autoClose 为 false，则即使出现错误，文件描述符也不会关闭。 关闭它并确保没有文件描述符泄漏是应用程序的责任。</p></li><li><p>默认情况下，流将在销毁后触发 &#39;close&#39; 事件。 将 emitClose 选项设置为 false 以更改此行为。</p></li><li><p>通过提供 fs 选项，可以覆盖 open、write、writev 和 close 的相应 fs 实现。 在没有 writev() 的情况下覆盖 write() 会降低性能，因为某些优化 (_writev()) 将被禁用。 当提供了 fs 选项时，则至少需要覆盖 write 和 writev 之一。 如果没有提供 fd 选项，则还需要覆盖 open。 如果 autoClose 是 true，则还需要覆盖 close。</p></li><li><p>与 &lt;fs.ReadStream&gt; 一样，如果指定了 fd，则 &lt;fs.WriteStream&gt; 将忽略 path 参数并使用指定的文件描述符。 这意味着不会触发 &#39;open&#39; 事件。 fd 应该是阻塞的；非阻塞 fd 应该传给 &lt;net.Socket&gt;。</p></li></ul><h3 id="示例" tabindex="-1">示例</h3><div class="language-js line-numbers-mode"><pre><code><span class="token keyword">let</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;fs&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> txt <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">createWriteStream</span><span class="token punctuation">(</span><span class="token string">&quot;./这是一个可写流创建的文件.txt&quot;</span><span class="token punctuation">,</span><span class="token punctuation">{</span>
    <span class="token literal-property property">flags</span><span class="token operator">:</span><span class="token string">&quot;w&quot;</span><span class="token punctuation">,</span>
    <span class="token literal-property property">encoding</span><span class="token operator">:</span><span class="token string">&quot;utf8&quot;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

txt<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">&quot;这是一串使用 utf8 编码写入的文本数据&quot;</span><span class="token punctuation">,</span><span class="token string">&#39;UTF8&#39;</span><span class="token punctuation">)</span>

<span class="token comment">// 标记文件末尾</span>
txt<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

txt<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;finish&#39;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;写入完成。&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

txt<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;error&#39;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
   console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">.</span>stack<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;运行完此脚本  在当前目录下会创建一个   这是一个可写流创建的文件.txt  的文件&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><h3 id="事件" tabindex="-1">事件</h3><p>对于<code>writable</code> 类它拥有诸多事件</p><h4 id="close-事件" tabindex="-1"><strong>close</strong> 事件</h4><p>写入流被关闭时触发</p><h4 id="drain-事件" tabindex="-1">**drain **事件</h4><p>如果对 stream.write(chunk) 的调用返回 false，则 &#39;drain&#39; 事件将在适合继续将数据写入流时触发。</p><div class="language-js line-numbers-mode"><pre><code><span class="token comment">// 将数据写入提供的可写流一百万次。</span>
<span class="token comment">// 注意背压。</span>
<span class="token keyword">function</span> <span class="token function">writeOneMillionTimes</span><span class="token punctuation">(</span><span class="token parameter">writer<span class="token punctuation">,</span> data<span class="token punctuation">,</span> encoding<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">1000000</span><span class="token punctuation">;</span>
  <span class="token function">write</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">function</span> <span class="token function">write</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> ok <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword">do</span> <span class="token punctuation">{</span>
      i<span class="token operator">--</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 最后一次！</span>
        writer<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> encoding<span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// 看看是应该继续，还是等待。</span>
        <span class="token comment">// 不要传入回调，因为还没有完成。</span>
        ok <span class="token operator">=</span> writer<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> encoding<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>i <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> ok<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 必须早点停下来！</span>
      <span class="token comment">// 等它排空时再写一些。</span>
      writer<span class="token punctuation">.</span><span class="token function">once</span><span class="token punctuation">(</span><span class="token string">&#39;drain&#39;</span><span class="token punctuation">,</span> write<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><h4 id="error-事件" tabindex="-1"><strong>error</strong> 事件</h4><p>写入或管道数据时发生错误触发，</p><p>除非在创建流时将 <a href="http://nodejs.cn/api/stream.html#new-streamwritableoptions" target="_blank" rel="noopener noreferrer"><code>autoDestroy</code></a> 选项设置为 <code>false</code>，否则当触发 <code>&#39;error&#39;</code> 事件时将关闭流。</p><p>在 <code>&#39;error&#39;</code> 之后，不应触发除 <code>&#39;close&#39;</code> 之外的其他事件（包括 <code>&#39;error&#39;</code> 事件）。</p><div class="language-js line-numbers-mode"><pre><code><span class="token keyword">const</span> <span class="token punctuation">{</span> Writable <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;node:stream&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> myStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Writable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> fooErr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&#39;foo error&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
myStream<span class="token punctuation">.</span><span class="token function">destroy</span><span class="token punctuation">(</span>fooErr<span class="token punctuation">)</span><span class="token punctuation">;</span>
myStream<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;error&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">fooErr</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>fooErr<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// foo error</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h4 id="finish-事件" tabindex="-1">**finish **事件</h4><p>调用writable.end()后，并且所有数据都已刷新到底层系统触发</p><h4 id="pipe-事件" tabindex="-1">**pipe **事件</h4><p>当在可读流上调用 <a href="http://nodejs.cn/api/stream.html#readablepipedestination-options" target="_blank" rel="noopener noreferrer"><code>stream.pipe()</code></a> 方法将此可写流添加到其目标集时，则触发 <code>&#39;pipe&#39;</code> 事件。</p><div class="language-js line-numbers-mode"><pre><code><span class="token keyword">const</span> writer <span class="token operator">=</span> <span class="token function">getWritableStreamSomehow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> reader <span class="token operator">=</span> <span class="token function">getReadableStreamSomehow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
writer<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;pipe&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">src</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;Something is piping into the writer.&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  assert<span class="token punctuation">.</span><span class="token function">equal</span><span class="token punctuation">(</span>src<span class="token punctuation">,</span> reader<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
reader<span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>writer<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h4 id="unpipe-事件" tabindex="-1"><strong>unpipe</strong> 事件</h4><p><code>src</code>取消管道此可写流的源流</p><p>当在 <a href="http://nodejs.cn/api/stream.html#class-streamreadable" target="_blank" rel="noopener noreferrer"><code>Readable</code></a> 流上调用 <a href="http://nodejs.cn/api/stream.html#readableunpipedestination" target="_blank" rel="noopener noreferrer"><code>stream.unpipe()</code></a> 方法时，则会触发 <code>&#39;unpipe&#39;</code> 事件，从其目标集合中删除此 <a href="http://nodejs.cn/api/stream.html#class-streamwritable" target="_blank" rel="noopener noreferrer"><code>Writable</code></a>。</p><p>当 <a href="http://nodejs.cn/api/stream.html#class-streamreadable" target="_blank" rel="noopener noreferrer"><code>Readable</code></a> 流管道进入它时，如果此 <a href="http://nodejs.cn/api/stream.html#class-streamwritable" target="_blank" rel="noopener noreferrer"><code>Writable</code></a> 流触发错误，则这也会触发。</p><div class="language-js line-numbers-mode"><pre><code><span class="token keyword">const</span> writer <span class="token operator">=</span> <span class="token function">getWritableStreamSomehow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> reader <span class="token operator">=</span> <span class="token function">getReadableStreamSomehow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
writer<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;unpipe&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">src</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;Something has stopped piping into the writer.&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  assert<span class="token punctuation">.</span><span class="token function">equal</span><span class="token punctuation">(</span>src<span class="token punctuation">,</span> reader<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
reader<span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>writer<span class="token punctuation">)</span><span class="token punctuation">;</span>
reader<span class="token punctuation">.</span><span class="token function">unpipe</span><span class="token punctuation">(</span>writer<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h3 id="方法" tabindex="-1">方法</h3><p>对于<code>writable</code> 类它也有拥有诸多方法</p><h4 id="writable-cork" tabindex="-1"><strong>writable.cork()</strong></h4><p><code>writable.cork()</code> 方法强制所有写入的数据都缓存在内存中。 当调用 <a href="http://nodejs.cn/api/stream.html#writableuncork" target="_blank" rel="noopener noreferrer"><code>stream.uncork()</code></a> 或 <a href="http://nodejs.cn/api/stream.html#writableendchunk-encoding-callback" target="_blank" rel="noopener noreferrer"><code>stream.end()</code></a> 方法时，缓冲的数据将被刷新。</p><p><code>writable.cork()</code> 的主要目的是适应将几个小块快速连续写入流的情况。 <code>writable.cork()</code> 不是立即将它们转发到底层目标，而是缓冲所有块，直到 <code>writable.uncork()</code> 被调用，如果存在，<code>writable.uncork()</code> 会将它们全部传给 <code>writable._writev()</code>。 这可以防止在等待处理第一个小块时正在缓冲数据的行头阻塞情况。 但是，在不实现 <code>writable._writev()</code> 的情况下使用 <code>writable.cork()</code> 可能会对吞吐量产生不利影响。</p><h4 id="writable-destroy" tabindex="-1"><strong>writable.destroy()</strong></h4><p>销毁流 可选地触发 <code>&#39;error&#39;</code> 事件，并且触发 <code>&#39;close&#39;</code> 事件（除非 <code>emitClose</code> 设置为 <code>false</code>）。 在此调用之后，则可写流已结束，随后对 <code>write()</code> 或 <code>end()</code> 的调用将导致 <code>ERR_STREAM_DESTROYED</code> 错误。 这是销毁流的破坏性和直接的方式。 先前对 <code>write()</code> 的调用可能没有排空，并且可能触发 <code>ERR_STREAM_DESTROYED</code> 错误。 如果数据应该在关闭之前刷新，或者在销毁流之前等待 <code>&#39;drain&#39;</code> 事件，则使用 <code>end()</code> 而不是销毁。</p><div class="language-js line-numbers-mode"><pre><code><span class="token keyword">const</span> <span class="token punctuation">{</span> Writable <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;stream&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> myStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Writable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> fooErr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&#39;foo error&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
myStream<span class="token punctuation">.</span><span class="token function">destroy</span><span class="token punctuation">(</span>fooErr<span class="token punctuation">)</span><span class="token punctuation">;</span>
myStream<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;error&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">fooErr</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>fooErr<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// foo error</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><div class="language-js line-numbers-mode"><pre><code><span class="token keyword">const</span> <span class="token punctuation">{</span> Writable <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;stream&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> myStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Writable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

myStream<span class="token punctuation">.</span><span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
myStream<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;error&#39;</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token function">wontHappen</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><div class="language-js line-numbers-mode"><pre><code><span class="token keyword">const</span> <span class="token punctuation">{</span> Writable <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;stream&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> myStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Writable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
myStream<span class="token punctuation">.</span><span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

myStream<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">&#39;foo&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>error<span class="token punctuation">.</span>code<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// ERR_STREAM_DESTROYED</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h4 id="writable-end" tabindex="-1"><strong>writable. end()</strong></h4><p>调用 writable.end() 方法表示不再有数据写入 Writable</p><div class="language-js line-numbers-mode"><pre><code><span class="token comment">// 语法：</span>
writable<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">[</span>chunk<span class="token punctuation">[</span><span class="token punctuation">,</span> encoding<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">,</span> callback<span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token literal-property property">chunk</span><span class="token operator">:</span>可选的要写入的数据。 对于不在对象模式下操作的流，chunk 必须是字符串、Buffer 或 Uint8Array。 对于对象模式的流，chunk 可以是除 <span class="token keyword">null</span> 之外的任何 JavaScript 值
<span class="token literal-property property">encoding</span><span class="token operator">:</span>编码
<span class="token literal-property property">callback</span><span class="token operator">:</span>流结束时的回调
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><div class="language-js line-numbers-mode"><pre><code><span class="token comment">// 写入 &#39;hello, &#39; 然后以 &#39;world!&#39; 结尾。</span>
<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;fs&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> file <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">createWriteStream</span><span class="token punctuation">(</span><span class="token string">&#39;example.txt&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
file<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">&#39;hello, &#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
file<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">&#39;world!&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 现在不允许写入更多！</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h4 id="writable-setdefaultencoding" tabindex="-1"><strong>writable.setDefaultEncoding ()</strong></h4><p>设置默认的编码(encoding)</p><div class="language-js line-numbers-mode"><pre><code>writable<span class="token punctuation">.</span><span class="token function">setDefaultEncoding</span><span class="token punctuation">(</span><span class="token string">&#39;utf-8&#39;</span><span class="token punctuation">)</span> 
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h4 id="writable-uncork" tabindex="-1"><strong>writable.uncork()</strong></h4><p><code>writable.uncork()</code> 方法会刷新自调用 <code>stream.cork()</code> 以来缓冲的所有数据。</p><p>当使用 <a href="http://nodejs.cn/api/stream.html#writablecork" target="_blank" rel="noopener noreferrer"><code>writable.cork()</code></a> 和 <code>writable.uncork()</code> 管理写入流的缓冲时，建议使用 <code>process.nextTick()</code> 延迟对 <code>writable.uncork()</code> 的调用。 这样做允许对在给定 Node.js 事件循环阶段中发生的所有 <code>writable.write()</code> 调用进行批处理。</p><div class="language-js line-numbers-mode"><pre><code>stream<span class="token punctuation">.</span><span class="token function">cork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
stream<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">&#39;some &#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
stream<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">&#39;data &#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
process<span class="token punctuation">.</span><span class="token function">nextTick</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> stream<span class="token punctuation">.</span><span class="token function">uncork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>如果在一个流上多次调用 <a href="http://nodejs.cn/api/stream.html#writablecork" target="_blank" rel="noopener noreferrer"><code>writable.cork()</code></a> 方法，则必须调用相同数量的 <code>writable.uncork()</code> 调用来刷新缓冲的数据。</p><div class="language-js line-numbers-mode"><pre><code>stream<span class="token punctuation">.</span><span class="token function">cork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
stream<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">&#39;some &#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
stream<span class="token punctuation">.</span><span class="token function">cork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
stream<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">&#39;data &#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
process<span class="token punctuation">.</span><span class="token function">nextTick</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  stream<span class="token punctuation">.</span><span class="token function">uncork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 在第二次调用 uncork() 之前不会刷新数据。</span>
  stream<span class="token punctuation">.</span><span class="token function">uncork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>另见: <a href="http://nodejs.cn/api/stream.html#writablecork" target="_blank" rel="noopener noreferrer"><code>writable.cork()</code></a>。</p><h4 id="writable-write-chunk-encoding-callback" tabindex="-1"><strong>writable.write(chunk[, encoding][, callback])</strong></h4><p>将数据写入流中，返回Boolean， 如果流希望调用代码在继续写入其他数据之前等待 <code>&#39;drain&#39;</code> 事件被触发，则为 <code>false</code>；否则为 <code>true</code>。</p><p>chunk：要写入的数据</p><p>encoding：字节编码</p><p>callback：当刷新此块数据时的回调</p><div class="language-js line-numbers-mode"><pre><code><span class="token keyword">let</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;fs&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> txt <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">createWriteStream</span><span class="token punctuation">(</span><span class="token string">&quot;./这是一个可写流创建的文件.txt&quot;</span><span class="token punctuation">,</span><span class="token punctuation">{</span>
    <span class="token literal-property property">flags</span><span class="token operator">:</span><span class="token string">&quot;w&quot;</span><span class="token punctuation">,</span>
    <span class="token literal-property property">encoding</span><span class="token operator">:</span><span class="token string">&quot;utf8&quot;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">function</span> <span class="token function">write</span><span class="token punctuation">(</span><span class="token parameter">data<span class="token punctuation">,</span> cb</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>txt<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span><span class="token string">&#39;UTF8&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment">//  .write()返回true表示能继续写入</span>
        txt<span class="token punctuation">.</span><span class="token function">once</span><span class="token punctuation">(</span><span class="token string">&#39;drain&#39;</span><span class="token punctuation">,</span> cb<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        process<span class="token punctuation">.</span><span class="token function">nextTick</span><span class="token punctuation">(</span>cb<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// 在执行任何其他写入之前等待回调被调用。</span>
<span class="token function">write</span><span class="token punctuation">(</span><span class="token string">&#39;这是一串使用 utf8 编码写入的文本数据,并且做了防止背压的操作&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;完成写入，现在就进行更多写入。&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token comment">// 标记文件末尾</span>
txt<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

txt<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;finish&#39;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;写入完成。&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

txt<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;close&#39;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;写入流已经被关闭。&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

txt<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;error&#39;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
   console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">.</span>stack<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

txt<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;pipe&#39;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;pipe&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;程序执行完毕&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br></div></div><h3 id="属性" tabindex="-1">属性</h3><p>对于<code>writable</code> 类它也有拥有诸多属性</p><ul><li><strong>writable.writable</strong></li></ul><p>如果调用 <code>writable.write()</code> 是安全的，则为 <code>true</code>，这意味着流没有被销毁、出错或结束。</p><ul><li><p><strong>writable.writableEnded</strong></p><p>在调用 <a href="http://nodejs.cn/api/stream.html#writableendchunk-encoding-callback" target="_blank" rel="noopener noreferrer"><code>writable.end()</code></a> 之后是 <code>true</code>。 此属性不指示数据是否已刷新，为此则使用 <a href="http://nodejs.cn/api/stream.html#writablewritablefinished" target="_blank" rel="noopener noreferrer"><code>writable.writableFinished</code></a> 代替。</p></li><li><p><strong>writable.writableCorked</strong></p><p>需要调用 <a href="http://nodejs.cn/api/stream.html#writableuncork" target="_blank" rel="noopener noreferrer"><code>writable.uncork()</code></a> 以完全解开流的次数。</p></li><li><p><strong>writable. writableFinished</strong></p><p>在触发 <a href="http://nodejs.cn/api/stream.html#event-finish" target="_blank" rel="noopener noreferrer"><code>&#39;finish&#39;</code></a> 事件之前立即设置为 <code>true</code>。</p></li><li><p><strong>writable.writableHighWaterMark</strong></p><p>返回创建此 <code>Writable</code> 时传入的 <code>highWaterMark</code> 的值。</p></li><li><p><strong>writable.writableLength</strong></p><p>此属性包含队列中准备写入的字节数（或对象数）。 该值提供有关 <code>highWaterMark</code> 状态的内省数据。</p></li><li><p><strong>writable.writableNeedDrain</strong></p><p>如果流的缓冲区已满并且流将触发 <code>&#39;drain&#39;</code>，则为 <code>true</code>。</p></li><li><p><strong>writable.writableObjectMode</strong></p><p>给定 <code>Writable</code> 流的属性 <code>objectMode</code> 的获取器。</p><p><strong>writable. destroyed()</strong></p><p>在调用 <code>writable.destro 之后是 </code>true`。</p><div class="language-js line-numbers-mode"><pre><code><span class="token keyword">const</span> <span class="token punctuation">{</span> Writable <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;stream&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> myStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Writable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>myStream<span class="token punctuation">.</span>destroyed<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// false</span>
myStream<span class="token punctuation">.</span><span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>myStream<span class="token punctuation">.</span>destroyed<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// true</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div></li></ul><h2 id="可读流-readable" tabindex="-1">可读流(readable)</h2><p>可读流是对消费的数据来源的抽象</p><p>常见的可读流有：</p><ul><li>客户端上的 HTTP 响应</li><li>服务器上的 HTTP 请求</li><li>文件系统读取流</li><li>压缩流</li><li>加密流</li><li>TCP 套接字</li><li>子进程的标准输出和标准错误</li><li>process.stdin</li></ul><h3 id="两种读取模式" tabindex="-1">两种读取模式</h3><p><code>readable</code>又两种模式之一有效的运行：流动和暂停。这些模式和对象模式是分开的。<code>readable</code>流可以处于或不处于对对象模式，无论是流动模式还是暂停模式。</p><ul><li>在流动模式下，数据会自动从底层系统读取，并通过EventEmitter接口使用事件尽快提供给应用程序。</li><li>在暂停模式下，必须显式调用<code>stream.read()</code>方法从流中读取数据块。</li></ul><p>所有的<code>readable</code>流都是以暂停模式开始的，可以 通过以下方式之一切换到流动模式：</p><ul><li>添加<code>data</code>事件监听</li><li>调用<code>stream.resume()</code>方法</li><li>调用<code>stream.pipe()</code>方法将数据发送到<code>writable</code></li></ul><p>可以使用以下方法之一切换回暂停模式：</p><ul><li>如果没有管道目标，则通过调用 <code>stream.pause()</code> 方法。</li><li>如果有管道目标，则删除所有管道目标。 可以通过调用 <code>stream.unpipe()</code>方法删除多个管道目标。</li></ul><p><strong>要记住的重要概念是，在提供消费或忽略该数据的机制之前，<code>Readable</code> 不会产生数据。 如果消费机制被禁用或移除，则 <code>Readable</code> 将尝试停止产生数据。</strong></p><p>出于向后兼容性的原因，删除 <a href="http://nodejs.cn/api/stream.html#event-data" target="_blank" rel="noopener noreferrer"><code>&#39;data&#39;</code></a> 事件句柄不会自动暂停流。 此外，如果有管道目标，则调用 <a href="http://nodejs.cn/api/stream.html#readablepause" target="_blank" rel="noopener noreferrer"><code>stream.pause()</code></a> 将不能保证一旦这些目标排空并要求更多数据，流将保持暂停状态。</p><p>如果 <a href="http://nodejs.cn/api/stream.html#class-streamreadable" target="_blank" rel="noopener noreferrer"><code>Readable</code></a> 切换到流动模式并且没有消费者可用于处理数据，则数据将被丢失。 例如，当调用 <code>readable.resume()</code> 方法而没有绑定到 <code>&#39;data&#39;</code> 事件的监听器时，或者当从流中删除 <code>&#39;data&#39;</code> 事件句柄时，就会发生这种情况。</p><p>添加 <a href="http://nodejs.cn/api/stream.html#event-readable" target="_blank" rel="noopener noreferrer"><code>&#39;readable&#39;</code></a> 事件句柄会自动使流停止流动，并且必须通过 <a href="http://nodejs.cn/api/stream.html#readablereadsize" target="_blank" rel="noopener noreferrer"><code>readable.read()</code></a> 来消费数据。 如果删除了 <a href="http://nodejs.cn/api/stream.html#event-readable" target="_blank" rel="noopener noreferrer"><code>&#39;readable&#39;</code></a> 事件句柄，则如果有 <a href="http://nodejs.cn/api/stream.html#event-data" target="_blank" rel="noopener noreferrer"><code>&#39;data&#39;</code></a> 事件句柄，流将再次开始流动。</p><h3 id="三种状态" tabindex="-1">三种状态</h3><p><code>Readable</code> 流的操作的&quot;两种模式&quot;是对 <code>Readable</code> 流实现中发生的更复杂的内部状态管理的简化抽象。</p><p>具体来说，在任何给定的时间点，每个 <code>Readable</code> 都处于三种可能的状态之一：</p><ul><li><code>readable.readableFlowing === null</code></li><li><code>readable.readableFlowing === false</code></li><li><code>readable.readableFlowing === true</code></li></ul><p>当 <code>readable.readableFlowing</code> 为 <code>null</code> 时，则不提供消费流数据的机制。 因此，流不会生成数据。 在此状态下，为 <code>&#39;data&#39;</code> 事件绑定监听器、调用 <code>readable.pipe()</code> 方法、或调用 <code>readable.resume()</code> 方法会将 <code>readable.readableFlowing</code> 切换到 <code>true</code>，从而使 <code>Readable</code> 在生成数据时开始主动触发事件。</p><p>调用<code>readable.pause()</code>、<code>readable.unpipe()</code>、或者接收背压都会导致 <code>readable.readableFlowing</code> 被设置为 <code>false</code>，暂时停止事件的流动，但不会停止数据的生成。 在此状态下，为 <code>&#39;data&#39;</code> 事件绑定监听器不会将 <code>readable.readableFlowing</code> 切换到 <code>true</code>。</p><div class="language-js line-numbers-mode"><pre><code><span class="token keyword">const</span> <span class="token punctuation">{</span> PassThrough<span class="token punctuation">,</span> Writable <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;stream&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> pass <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PassThrough</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> writable <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Writable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

pass<span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>writable<span class="token punctuation">)</span><span class="token punctuation">;</span>
pass<span class="token punctuation">.</span><span class="token function">unpipe</span><span class="token punctuation">(</span>writable<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// readableFlowing 现在为 false。</span>

pass<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;data&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">chunk</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>chunk<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
pass<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">&#39;ok&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 不会触发 &#39;data&#39;。</span>
pass<span class="token punctuation">.</span><span class="token function">resume</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// 必须调用才能使流触发 &#39;data&#39;。</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h3 id="选择一种接口风格" tabindex="-1">选择一种接口风格</h3><p>虽然 <code>readable.readableFlowing</code> 是 <code>false</code>，但数据可能会在流的内部缓冲区中累积。</p><p><code>Readable</code> 流的 API 跨越多个 Node.js 版本的演进，并提供了多种消费流数据的方法。 一般情况下，开发者应该选择其中一种消费数据的方式，切忌使用多种方式消费单一流中的数据。 具体来说，使用 <code>on(&#39;data&#39;)</code>、<code>on(&#39;readable&#39;)</code>、<code>pipe()</code> 或异步迭代器的组合可能会导致不直观的行为。</p><p>建议大多数用户使用 <code>readable.pipe()</code> 方法，因为它已被实施以提供使用流数据的最简单方法。 需要对数据传输和生成进行更细粒度控制的开发者可以使用 <a href="http://nodejs.cn/api/events.html#class-eventemitter" target="_blank" rel="noopener noreferrer"><code>EventEmitter</code></a> 和 <code>readable.on(&#39;readable&#39;)</code>/<code>readable.read()</code> 或 <code>readable.pause()</code>/<code>readable.resume()</code> API。</p><h3 id="创建可读流" tabindex="-1">创建可读流</h3><h3 id="示例-1" tabindex="-1">示例</h3><h3 id="事件-1" tabindex="-1">事件</h3><p>对于<code>Readable</code> 类它拥有诸多事件</p><p><code>&#39;close&#39;</code> <strong>事件</strong></p><p><code>&#39;data&#39;</code> <strong>事件</strong></p><p><code>&#39;end&#39;</code> <strong>事件</strong></p><p><code>&#39;error&#39;</code> <strong>事件</strong></p><p><code>&#39;pause&#39;</code> <strong>事件</strong></p><p><code>&#39;readable&#39;</code> <strong>事件</strong></p><p><code>&#39;resume&#39;</code> <strong>事件</strong></p><h3 id="方法-1" tabindex="-1">方法</h3><p>对于<code>Readable</code> 类它拥有诸多方法</p><p><strong>readable.destroy([error])</strong></p><p><strong>readable.destroyed</strong></p><p><strong>readable.isPaused()</strong></p><p><strong>readable.pause()</strong></p><p><strong>readable.pipe(destination[, options])</strong></p><p><strong>readable.unpipe([destination])</strong></p><p><strong>readable.unshift(chunk[, encoding])</strong></p><p><strong>readable.read([size])</strong></p><p><strong>readable.resume()</strong></p><p><strong>readable.setEncoding(encoding)</strong></p><p><strong>eadable.wrap(stream)</strong></p><h3 id="属性-1" tabindex="-1">属性</h3><p>对于<code>Readable</code> 类它拥有诸多属性</p><p><strong>readable.readable</strong></p><p><strong>readable.readableAborted</strong></p><p><strong>readable.readableDidRead</strong></p><p><strong>readable.readableEncoding</strong></p><p><strong>readable.readableEnded</strong></p><p><strong>readable.readableFlowing</strong></p><p><strong>readable.readableHighWaterMark</strong></p><p><strong>readable.readableLength</strong></p><p><strong>readable.readableObjectMode</strong></p><div class="language-js line-numbers-mode"><pre><code>fs<span class="token punctuation">.</span><span class="token function">createReadStream</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span><span class="token punctuation">{</span>
    flags <span class="token operator">&lt;</span>string<span class="token operator">&gt;</span> 请参阅对文件系统 flags 的支持。 默认值<span class="token operator">:</span> <span class="token string">&#39;r&#39;</span>。
    <span class="token literal-property property">encoding</span><span class="token operator">:</span><span class="token string">&#39;utf-8&#39;</span><span class="token punctuation">,</span>	<span class="token comment">// 默认值: null</span>
    fd <span class="token operator">&lt;</span>integer<span class="token operator">&gt;</span> <span class="token operator">|</span> <span class="token operator">&lt;</span>FileHandle<span class="token operator">&gt;</span> 默认值<span class="token operator">:</span> <span class="token keyword">null</span> 
    mode <span class="token operator">&lt;</span>integer<span class="token operator">&gt;</span> 默认值<span class="token operator">:</span> <span class="token number">0o666</span>
    autoClose <span class="token operator">&lt;</span>boolean<span class="token operator">&gt;</span> 默认值<span class="token operator">:</span> <span class="token boolean">true</span>
    <span class="token literal-property property">emitClose</span><span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>	 <span class="token comment">// 默认值: true</span>
    <span class="token literal-property property">start</span><span class="token operator">:</span><span class="token number">3</span><span class="token punctuation">,</span>		<span class="token comment">// 从索引3开始读</span>
    <span class="token literal-property property">end</span><span class="token operator">:</span><span class="token number">100</span><span class="token punctuation">,</span>		<span class="token comment">// 读到索引为100的  包括结束</span>
    <span class="token literal-property property">highWaterMark</span><span class="token operator">:</span><span class="token number">1000</span><span class="token punctuation">,</span> <span class="token comment">// 默认值: 64 * 1024(64kb)</span>
    fs <span class="token operator">&lt;</span>Object<span class="token operator">&gt;</span> <span class="token operator">|</span> <span class="token operator">&lt;</span><span class="token keyword">null</span><span class="token operator">&gt;</span> 默认值<span class="token operator">:</span> <span class="token keyword">null</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
encoding 可以是 <span class="token operator">&lt;</span>Buffer<span class="token operator">&gt;</span> 接受的任何一种。
如果指定了 fd，则 ReadStream 将忽略 path 参数并使用指定的文件描述符。 这意味着不会触发 <span class="token string">&#39;open&#39;</span> 事件。 fd 应该是阻塞的；非阻塞 fd 应该传给 <span class="token operator">&lt;</span>net<span class="token punctuation">.</span>Socket<span class="token operator">&gt;</span>。
如果 fd 指向仅支持阻塞读取的字符设备（例如键盘或声卡），则读取操作不会在数据可用之前完成。 这可以防止进程退出和流自然关闭。
默认情况下，流将在销毁后触发 <span class="token string">&#39;close&#39;</span> 事件。 将 emitClose 选项设置为 <span class="token boolean">false</span> 以更改此行为。
如果 autoClose 为 <span class="token boolean">false</span>，则即使出现错误，文件描述符也不会关闭。 关闭它并确保没有文件描述符泄漏是应用程序的责任。 如果 autoClose 设置为 <span class="token boolean">true</span>（默认行为），则在 <span class="token string">&#39;error&#39;</span> 或 <span class="token string">&#39;end&#39;</span> 时，文件描述符将自动关闭。
mode 设置文件模式（权限和粘滞位），但前提是文件已创建。
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>事件</p><div class="language-js line-numbers-mode"><pre><code><span class="token keyword">let</span> a <span class="token operator">=</span> <span class="token function">createReadStream</span><span class="token punctuation">(</span><span class="token string">&quot;./test.txt&quot;</span><span class="token punctuation">)</span>

<span class="token comment">/*
** 方法
*/</span>
a<span class="token punctuation">.</span><span class="token function">pause</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">// 将导致处于流动模式的流停止触发 &#39;data&#39; 事件，切换出流动模式。 任何可用的数据都将保留在内部缓冲区中</span>
a<span class="token punctuation">.</span><span class="token function">isPaused</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 方法返回 Readable(a) 的当前运行状态</span>
a<span class="token punctuation">.</span><span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 销毁流状态，可选地触发 &#39;error&#39; 事件，并且触发 &#39;close&#39; 事件（除非 emitClose 设置为 false）在此调用之后，可读流将释放任何内部资源，随后对 push() 的调用将被忽略。</span>
<span class="token comment">// 一旦 destroy() 被调用，任何进一步的调用都将是空操作，除了来自 _destroy() 的其他错误可能不会作为 &#39;error&#39; 触发。</span>
a<span class="token punctuation">.</span><span class="token function">resume</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 继续触发 &#39;data&#39; 事件 </span>
a<span class="token punctuation">.</span><span class="token function">destroyed</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 是否调用了destroy方法</span>
a<span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token punctuation">)</span>      <span class="token comment">// </span>

<span class="token comment">// 虽然 readable.readableFlowing 是 false，但数据可能会在流的内部缓冲区中累积。</span>
<span class="token comment">/*
** 事件
*/</span>
<span class="token comment">// 监听数据流事件</span>
a<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;data&quot;</span><span class="token punctuation">,</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">param</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;data&quot;</span><span class="token punctuation">,</span>param<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// 从流中读取的数据或已到达流的末尾时触发</span>
a<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;readable&quot;</span><span class="token punctuation">,</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">param</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 现在有一些数据要读取。</span>
    <span class="token keyword">let</span> data<span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>data <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment">// this.read() 可能为null</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;readable&quot;</span><span class="token punctuation">,</span>data<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// 监听数据流结束事件</span>
a<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;end&quot;</span><span class="token punctuation">,</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">param</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;end&quot;</span><span class="token punctuation">,</span>param<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// 监听数据流错误事件</span>
a<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;error&quot;</span><span class="token punctuation">,</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">param</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;error&quot;</span><span class="token punctuation">,</span>param<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// 监听数据流打开事件</span>
a<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;open&quot;</span><span class="token punctuation">,</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">param</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    a<span class="token punctuation">.</span><span class="token function">pause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 如果有 &#39;readable&#39; 事件监听器，则 a.pause() 方法不起作用</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;open&quot;</span><span class="token punctuation">,</span>param<span class="token punctuation">)</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;Now data will start flowing again.&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        a<span class="token punctuation">.</span><span class="token function">resume</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// a.destroy();</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// 监听数据流暂停事件</span>
a<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;pause&quot;</span><span class="token punctuation">,</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">param</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;pause&quot;</span><span class="token punctuation">,</span>param<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// 监听数据流关闭事件</span>
a<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;close&quot;</span><span class="token punctuation">,</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">param</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;pause&quot;</span><span class="token punctuation">,</span>param<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// 监听数据流关闭事件 === 当调用 stream.resume() 并且 readableFlowing 不是 true 时，则会触发 &#39;resume&#39; 事件。</span>
a<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;resume&quot;</span><span class="token punctuation">,</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">param</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;resume&quot;</span><span class="token punctuation">,</span>param<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br></div></div><blockquote><p>一般来说，readable.pipe() 和 &#39;data&#39; 事件机制比 &#39;readable&#39; 事件更容易理解。 但是，处理 &#39;readable&#39; 可能会导致吞吐量增加。 如果同时使用 &#39;readable&#39; 和 &#39;data&#39;，则 &#39;readable&#39; 优先控制流，即只有在调用 stream.read() 时才会触发 &#39;data&#39;。 readableFlowing 属性将变为 false。 如果在移除 &#39;readable&#39; 时有 &#39;data&#39; 个监听器，则流将开始流动，即 &#39;data&#39; 事件将在不调用 .resume() 的情况下触发。</p></blockquote><h2 id="双工流" tabindex="-1">双工流()</h2><h2 id="转化流" tabindex="-1">转化流</h2><h2 id="附表1" tabindex="-1">附表1</h2><ul><li><p><code>&#39;a&#39;</code>: 打开文件进行追加。 如果文件不存在，则创建该文件。</p></li><li><p><code>&#39;ax&#39;</code>: 类似于 <code>&#39;a&#39;</code> 但如果路径存在则失败。</p></li><li><p><code>&#39;a+&#39;</code>: 打开文件进行读取和追加。 如果文件不存在，则创建该文件。</p></li><li><p><code>&#39;ax+&#39;</code>: 类似于 <code>&#39;a+&#39;</code> 但如果路径存在则失败。</p></li><li><p><code>&#39;as&#39;</code>: 以同步模式打开文件进行追加。 如果文件不存在，则创建该文件。</p></li><li><p><code>&#39;as+&#39;</code>: 以同步模式打开文件进行读取和追加。 如果文件不存在，则创建该文件。</p></li><li><p><code>&#39;r&#39;</code>: 打开文件进行读取。 如果文件不存在，则会发生异常。</p></li><li><p><code>&#39;r+&#39;</code>: 打开文件进行读写。 如果文件不存在，则会发生异常。</p></li><li><p><code>&#39;rs+&#39;</code>: 以同步模式打开文件进行读写。 指示操作系统绕过本地文件系统缓存。</p><p>这主要用于在 NFS 挂载上打开文件，因为它允许跳过可能过时的本地缓存。 它对 I/O 性能有非常实际的影响，因此除非需要，否则不建议使用此标志。</p><p>这不会将 <code>fs.open()</code> 或 <code>fsPromises.open()</code> 变成同步阻塞调用。 如果需要同步操作，应该使用类似 <code>fs.openSync()</code> 的东西。</p></li><li><p><code>&#39;w&#39;</code>: 打开文件进行写入。 创建（如果它不存在）或截断（如果它存在）该文件。</p></li><li><p><code>&#39;wx&#39;</code>: 类似于 <code>&#39;w&#39;</code> 但如果路径存在则失败。</p></li><li><p><code>&#39;w+&#39;</code>: 打开文件进行读写。 创建（如果它不存在）或截断（如果它存在）该文件。</p></li><li><p><code>&#39;wx+&#39;</code>: 类似于 <code>&#39;w+&#39;</code> 但如果路径存在则失败。</p></li></ul><h2 id="压背-backpressure" tabindex="-1">压背( Backpressure)</h2><p>一般是指buffer达到上限，简单讲就是上游的生产速度大于下游的消费速度</p></div></div><footer class="page-footer" data-v-7eddb2c4 data-v-fb8d84c6><div class="edit" data-v-fb8d84c6><div class="edit-link" data-v-fb8d84c6 data-v-1ed99556><!----></div></div><div class="updated" data-v-fb8d84c6><p class="last-updated" data-v-fb8d84c6 data-v-5797b537><span class="prefix" data-v-5797b537>最近更新时间:</span><span class="datetime" data-v-5797b537></span></p></div></footer><!----><!--[--><!--]--></div></main></div><!----><!--]--></div>
    <script>__VP_HASH_MAP__ = JSON.parse("{\"ideshortcutkey_webstorm.md\":\"828e1f56\",\"about_index.md\":\"59f3fd86\",\"client_css_滚动条.md\":\"3543a498\",\"client_electron_base.md\":\"38948292\",\"client_electron_index.md\":\"2d23de4e\",\"client_typescript_index.md\":\"b691a29c\",\"client_javascript_xmlhttprequest.md\":\"3f241bf7\",\"client_javascript_base.md\":\"099f4256\",\"client_javascript_index.md\":\"5474ef04\",\"client_javascript_函数.md\":\"e0a6219c\",\"concat_index.md\":\"404ae78b\",\"environmentconstruction_index.md\":\"5eaf64ec\",\"environmentconstruction_linux.md\":\"c6684331\",\"environmentconstruction_mysql离线安装.md\":\"0fc7b69f\",\"environmentconstruction_nginx.md\":\"0a27482d\",\"environmentconstruction_redis离线安装.md\":\"cc60bf5b\",\"home_home.md\":\"2a3a55c7\",\"index.md\":\"31c87e81\",\"interest_drug_index.md\":\"55a69d9f\",\"interest_music_index.md\":\"459e6397\",\"npmpackage_index.md\":\"cd073440\",\"npmpackage_log4js.md\":\"62d30128\",\"qdcz-note.md\":\"a232f1a9\",\"service_linux_index.md\":\"831c1602\",\"service_linux_linux.md\":\"b3f7a648\",\"service_linux_存储单位.md\":\"c7f95837\",\"service_mongodb_base.md\":\"d06161a2\",\"service_mongodb_index.md\":\"fef0fff2\",\"service_mongodb_建立ttl索引.md\":\"5f7de8f2\",\"service_nginx_index.md\":\"867eb253\",\"service_nginx_window版本.md\":\"6d02c371\",\"service_nodejs_base.md\":\"43f94331\",\"service_nodejs_buffer.md\":\"c8355f39\",\"service_nodejs_index.md\":\"d095999b\",\"service_nodejs_stream.md\":\"55a82ef5\",\"service_nodejs_锁.md\":\"8686efb8\",\"softwareengineering_面向对象编程.md\":\"13f5e349\",\"temporary_index.md\":\"0a315fcb\",\"temporary_recentplan.md\":\"e63e76de\",\"temporary_websocketforauthbynodejs.md\":\"d3ed10cd\",\"temporary_work_day_work_report.md\":\"e49a7c24\",\"temporary_work_todayplan.md\":\"f4e2b428\",\"temporary_work_weekly_work_report.md\":\"ca974ee9\",\"windowsystem_index.md\":\"064263bc\",\"windowsystem_创建本地共享文件夹.md\":\"f3b55361\"}")</script>
    <script type="module" async src="/assets/app.63212dfc.js"></script>
    
  </body>
</html>