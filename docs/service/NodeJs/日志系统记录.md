# 日志分析系统

采用 `log4js` 作为日志采集和简单的本地记录

## 代码

### project/config/log4js.js

```js
/*  project/config/log4js.js    */

const path = require('path');
const process = require('node:process');
//日志保存的根目录
const baseLogPath = path.join(process.cwd(), '/logs');

module.exports = {
    "baseLogPath": baseLogPath,
    //日志格式等设置
    appenders: {
        "rule-console": {"type": "console"},
        // 系统程序运行时日志
        "system": {
            "type": "file",
            "filename": baseLogPath + '/system/out',
            "pattern": "yyyy-MM-dd~hh-mm.log",
            "alwaysIncludePattern": true,
            "encoding": "utf-8",
            "maxLogSize": 1024 * 1024 * 100, // 文件最大存储空间,单位是字节
            "timeout":20,
            "numBackups": 10,
            "path": '/system',
            "layout": {
                "type": "json",
                "separator": ",",
            }
        },
        "errorLogger": {
            "type": "file", // 日志类型
            "filename": baseLogPath + '/error/error', // 输出文件名
            "pattern": "yyyy-MM-dd~hh-mm.log", // 后缀
            "alwaysIncludePattern": true, // 上面两个参数是否合并
            "encoding": "utf-8", // 编码格式
            "maxLogSize": 1024 * 1024 * 100,
            "timeout":20,
            "numBackups": 10,
            "path": '/error',
            "layout": {
                "type": "json",
                "separator": ",",
            }
        },
        // 接口请求日志
        "api": {
            "type": "file",
            "filename": baseLogPath + '/api/api',
            "pattern": "yyyy-MM-dd~hh-mm.log",
            "alwaysIncludePattern": true,
            "encoding": "utf-8",
            "maxLogSize": 1024 * 1024 * 100,
            "numBackups": 10,
            "timeout":20,
            "path": '/api',
            "layout": {
                "type": "json",
                "separator": ",",
            }
        },
        // 数据库操作日志
        "dbHandle": {
            "type": "file",
            "filename": baseLogPath + '/dbHandle/dbHandle',
            "pattern": "yyyy-MM-dd~hh-mm.log",
            "alwaysIncludePattern": true,
            "encoding": "utf-8",
            "path": '/dbHandle',
            "layout": {
                "type": "json",
                "separator": ",",
            }
        }
    },
    // 分类以及日志等级
    categories: {
        "default": {"appenders": ["rule-console"], "level": "all"},
        "apiLogger": {"appenders": ["api"], "level": "info"},
        // "errorLogger": {"appenders": ["errorLogger"], "level": "error"},
        // "dbHandleLogger": {"appenders": ["dbHandle"], "level": "all"},
        "systemLogger": {"appenders": ["system"], "level": "all"}
    },
}

```

### project/utils/logTolls.js


```js
/*  project/utils/logTolls.js  */


const log4js = require('log4js');
const logsConfig = require('../config/log4js');
const uuid = require("uuid");
const globalConfig = require('../config/index');
// 设置日志自定义布局为json格式
log4js.addLayout('json', function (config) {
    return function (logEvent) {
        return JSON.stringify(logEvent) + config.separator;
    }
})
//加载配置文件
log4js.configure(logsConfig);
//调用预先定义的日志名称
const apiLogger = log4js.getLogger("apiLogger");
// const errorLogger = log4js.getLogger("errorLogger");
// const dbHandleLogger = log4js.getLogger("dbHandleLogger");
const systemLogger = log4js.getLogger("systemLogger");
const consoleLogger = log4js.getLogger();


// 格式化日志文本 加上日志头尾和换行方便查看 ==>  普通日志、请求日志、响应日志、操作日志、错误日志
const formatText = {
    /**
     * 系统日志打印
     * @param info
     * @returns {String}
     */
    system: function (info) {
        return info;
    },
    /**
     * 数据库操作日志
     * @param info
     * @returns {String}
     */
    dbHandle: function (info) {
        return info
    },
    /**
     * 请求日志打印
     * @param ctx
     * @param uuid
     * @returns {String}
     */
    request: function (ctx, uuid, intervals) {
        return {
            requestUrl: ctx.url,
            requestHref: ctx.headers['request-href'],
            requestUuid: uuid,
            requestMethod: ctx.req.method,
            requestClientRemoteAddress: (ctx.headers['x-forwarded-for'] || ctx.ip || ctx.ips),
            requestQuery: ctx.request.query,
            requestBody: ctx.request.body,

            responseStatus: ctx.status,
            requestTime: intervals,
            responseBody: ctx.body,
        }
    },
    // 接口请求错误日志打印
    requestError: function (ctx, uid, err, intervals) {
        let obj = this.request(ctx, uid, intervals);
        return Object.assign(obj, {
            data: {
                // name:err.name,
                // message:err.message,
                stack: err?.stack || err
            }
        })
    }
}

module.exports = {
    formatText,
    //系统程序运行打印
    logSystem: function (info, type = 'info') {
        if (info) {
            systemLogger[type](formatText.system(info));
        }
    },
};

```

###  project/utils/apiLog.js


```js
/*  project/utils/apiLog.js     */


const uuid = require("uuid");
const globalConfig = require("../config");
const tools = require("./tools");
const {formatText} = require("../utils/logTolls");
const _Emitter = require("./events");
const log4js = require("log4js");
const apiLogger = log4js.getLogger("apiLogger");

const noRecordToLog = ['/logs/logList', '/logs/log'] // 无需写入日志的接口调用


module.exports = function () {
    return async function (ctx, next) {
        let uid = await uuid.v4();
        const start = new Date();					                // 开始时间
        let intervals;
        try {
            await next();
            // 日志查询接口,是不能记录下来的，否者会出现无线套娃，数据量越堆越大。
            // if (ctx.url == '/logs/logList') return
            if (ctx.url.match(/^\/logs/)) return
            intervals = new Date() - start;
            let logInfo = formatText.request(ctx, uid, intervals)
            

            // 代理接口的 请求前缀 和 响应数据（源）
            if(ctx.requestProxyOtiton && ctx.requestProxyData){
                logInfo['requestProxyOtiton'] = ctx.requestProxyOtiton
                logInfo['requestProxyData'] = ctx.requestProxyData
            }


            if (globalConfig.ApiSyncInStorage) { // 直接入库
                // 多个文件互相引用会有问题！！!
                let data = tools.dataProcessForLogCategory({          // 处理格式要跟日志文件内的一样
                    categoryName: "apiLogger",
                    context: {},
                    level: {level: 10000, levelStr: 'INFO', colour: 'green'},
                    pid: '00000',
                    startTime: new Date(),
                    data: [JSON.stringify(logInfo)]
                })
                _Emitter.emit("dataInStorage", data)
            } else { // 日志输入
                apiLogger.info(JSON.stringify(logInfo))
            }


        } catch (error) {
            intervals = new Date() - start;
            let logError = formatText.requestError(ctx, uid, error, intervals)
            apiLogger.error(JSON.stringify(logError))
            ctx.body = "接口异常，请联系管理员分析日志:" + error
        }
    }
}

```

### 在app.js上使用

```js
/*  app.js  */
const Koa = require('koa');
const app = new Koa();
const apiLog = require("./utils/apiLog");
const logAutoSync = require("./utils/autoSyncLocalLogFile");
// 接口日志收集
app.use(apiLog());

// 自动同步【自定义分钟】前的日志入库
logAutoSync({
    prefixDir:join(process.cwd(), './logs'), // 路径前缀
    LogRetentionDuration: 1000 * 60 * 60 * 12, // 保留近12小时的日志【执行删除会在凌晨2~6点内执行一次】
    timeThreshold: 1000 * 60 * 3,// 时间阈值 取前3分钟到前6分钟之内的日志文件
    syncFileLogList: ['api', 'system'], // 需要同步的本地日志二级目录
});
```

### 日志同步入库文件：

```js
/*  project/utils/autoSyncLocalLogFile.js  */


const { resolve, join } = require('path');
const fs = require("fs");
const { Buffer } = require('buffer');
const logModel = require("../control/logger");
const { logSystem } = require("./logTolls");
const tools = require("./tools");
const DateFormat = require("date-format");
/**
 * 思路：
 * 日志切割粒度 按分钟切割
 * 文件格式布局 日志改成自定义布局 使用json形式
 * 同步策略：
 * 每隔【自定义分钟】自动同步之前的日志，同步完之后直接删除本地文件 --- 后续可以在子进程处理此过程
 *
 *
 *
 * 
 * 遗留问题 
 *      在服务重启的阶段会【或宕机重启】 重复同步本地日志数据 造成数据冗余
 * 自动同步文件数据到数据库
 * @param opt
 */
const logAutoSync = function (opt) {
    let isClearIng = false;  // 自动清理日志文件

    opt = opt || {
        prefixDir: resolve(__dirname, '../logs'),// 目录前缀
        timeThreshold: 1000 * 60 * 3,// 时间阈值 取前3分钟到前6分钟之内的日志文件
        syncFileLogList: ['api', 'system'], // 需要同步的本地日志二级目录
        LogRetentionDuration: 1000 * 60 * 60 * 12, // 日志保留时长(清理时间默认在凌晨2点到6点清理完成)
    }

    const run = async function () {
        let needSyncLogFilePath = []; // 需要同步的日志文件列表
        let curTime = DateFormat('yyyy-MM-dd hh:mm', new Date()) + ":00"; // 当前时间
        // 先遍历指定目录下的日志文件
        for (let i = 0; i < opt.syncFileLogList.length; i++) {
            let dirName = opt.syncFileLogList[i];
            let list = await fs.readdirSync(opt.prefixDir + '/' + dirName);
            list = list.map(v => {
                let timeOfFileName = v.split('.')[1].replace("~", " ").split(" ");   // [ '2022-06-16', '23-54' ]
                let YYMMDD = timeOfFileName[0];                                                             // 2022-06-16
                let hhmmss = timeOfFileName[1].replace("-", ":") + ":00";             // 23:57:00
                let YYMMDDhhmmss = YYMMDD + " " + hhmmss;                                                   // 2022-06-17 00:31:00
                let timeGap =  new Date(curTime).getTime() - new Date(YYMMDDhhmmss).getTime()            // 时间差
                if (timeGap >= opt.timeThreshold && timeGap < opt.timeThreshold * 2) {                     // 只取范围内的时间(日志)文件
                    return join(opt.prefixDir, join(`/${dirName}`, `/${v}`))
                }
                return null
            }).filter(v => v)
            needSyncLogFilePath = needSyncLogFilePath.concat(list)
        }
        
        console.log('需要同步的文件', needSyncLogFilePath)

        for (let index = 0; index < needSyncLogFilePath.length; index++) {
            let fileName = needSyncLogFilePath[index];
            fs.access(fileName, fs.constants.F_OK, (err) => {
                if (err) {
                    return console.log('file does not exist', err);
                }
                fs.access(fileName, fs.constants.R_OK, async (err1) => {
                    if (err1) {
                        return console.log('file unreadable', err1);
                    }
                    const file = await fs.readFileSync(fileName);
                    let fileContent = Buffer.from(file).toString("utf8");
                    fileContent = "[" + fileContent.slice(0, -3) + "]"
                    fileContent = JSON.parse(fileContent)
                    if (fileContent.length > 0) {
                        let _dataItem = []
                        fileContent.forEach(item => {
                            let arr = tools.dataProcessForLogCategory(item)
                            if (arr) {
                                _dataItem.push(arr);
                                // 将指定数据存到数据库中
                                let res = saveLogToDataBase(_dataItem);
                                if (!res) {
                                    return logSystem(`数据同步到库失败` + res, 'error');
                                }
                            }
                        })
                    }

                });
            });
        }

        // 深更半夜的时候清除日志   当天2点到6点的时候 只清理一次
        let hh = new Date().getHours();
        if (hh >= 2 && hh < 6 && !isClearIng) {
            isClearIng = true;
            setTimeout(()=>{
                // 保证不会与上面的同步文件冲突了
                autoClearLogsFile(opt)
            },1000*60)
        } else {
            isClearIng = false;
        }
    }


    run().then(r => { })

    //TODO 上个锁，在前置操作没执行完之前不允许下一次同步
    setInterval(run, opt.timeThreshold);
}


/**
 * 将数据存入到数据库的logs文档中
 * @param $document   文档(表)
 * @param $data       数据集合
 */
const saveLogToDataBase = async function ($data) {
    try {
        let res = null
        if (!$data) return // console.error("$data不能为空");
        if (Array.isArray($data)) {
            if ($data.length == 0) return // console.error("$data不能为空")
            res = await logModel.addMany($data);
        } else {
            res = await logModel.add($data);
        }
        return res
    } catch (e) {
        logSystem(`saveLogToDataBase错误` + e, 'error');
        return null
    }
}


/**
 * 自动清空日志文件
 * @param {*} opt 
 * @returns 
 */
const autoClearLogsFile = async function (opt) {
    let needDelLogFilePath = [];
    for (let i = 0; i < opt.syncFileLogList.length; i++) {
        let dirName = opt.syncFileLogList[i];
        let list = await fs.readdirSync(opt.prefixDir + '/' + dirName);
        list = list.map(v => {
            let timeOfFileName = v.split('.')[1].replace("~", " ").split(" ");   // [ '2022-06-16', '23-54' ]
            let YYMMDD = timeOfFileName[0];                                                             // 2022-06-16
            let hhmmss = timeOfFileName[1].replace("-", ":") + ":00";             // 23:57:00
            let YYMMDDhhmmss = YYMMDD + " " + hhmmss;                                                   // 2022-06-17 00:31:00
            let timeGap = Date.now() - new Date(YYMMDDhhmmss).getTime()                                 // 时间差
            if (timeGap > opt.LogRetentionDuration) {                     // 只取范围外的时间(日志)文件
                return join(opt.prefixDir, join(`/${dirName}`, `/${v}`))
            }
            return null
        }).filter(v => v)
        needDelLogFilePath = needDelLogFilePath.concat(list)
    }
    // console.log('需要删除的文件', needDelLogFilePath)
    needDelLogFilePath.forEach(item => {
        fs.unlink(item, (err) => {
            if (err) {
                console.log(err)
            }
        });
        logSystem(`${item}日志文件删除成功`)
    })
    return needDelLogFilePath
}




module.exports = logAutoSync
```

### 日志表数据建模

```js
const mongoose = require('mongoose');

/**
 * 日志表数据建模
 *
 */
const logSchema = new mongoose.Schema({
    startTime: Date, // 开始时间
    createAt: { // ttl索引
        type: Date,
        default: Date.now,
        expires: 1000 * 60 * 60 * 24
    },
    uuid: String, // uuid
    logType: String,  // 日志类型
    logLevel: String, // 日志等级
    /**
     * 以下是针对系统[运行/报错]打印格式的数据建模
     */
    data: String,  // 系统日志打印内容
    /**
     * 以下是针对restfulApi格式的数据建模
     */
    url: String,  // 请求路径
    method: String, // 请求方法
    remoteAddress: String, // 请求地址
    requestHref: String, // 请求路径 www.xxx.com/a/b/c/d.html
    requestQuery: String, // 请求query入参
    requestBody: String,   // 请求body 入参
    status: String, // 响应状态
    responseData: String, // 响应数据
    responseSpeed: Number, // 响应时间(单位s)

    /**
     * 以下是针对代理接口格式的数据建模
     */
    requestProxyOtiton: String,  // 代理请求入参
    requestProxyData: String      // 代理请求响应的源数据
});

module.exports = logSchema
```

### 日志接口代码

#### control层

```js
const {logModel} = require("../db/model");
const {logSystem} = require('../utils/logTolls');

// class logger {
//     constructor() {
//
//     }
//
// }

// logModel = new proxy(logModel)

/**
 * 添加一条数据
 * @param data
 * @returns {Promise<unknown>}
 */
const add = function (data) {
    return new Promise((res, rej) => {
        let _logger = new logModel(data)
        _logger.save((err, data) => {
            if (err) {
                logSystem(err, 'error');
                rej(err)
                return
            }
            const resData = {dbCode: 200, msg: "数据插入成功!", data};
            res(resData);
            // logSystem(JSON.stringify(resData));
        })
    })
}

/**
 * 通过id查询数据
 * @param id
 * @returns {Promise<unknown>}
 */
const selectById = async function (id) {
    return new Promise((res, rej) => {
        logModel.findById(id, (err, data) => {
            if (err) {
                logSystem(err, 'error');
                rej(err)
                return
            }
            const resData = {dbCode: 200, msg: "数据查询成功!", data};
            res(resData);
            // logSystem(JSON.stringify(resData));
        });
    })
}

/**
 * 通过指定属性查询删除数据
 * @param arg    过滤器对象
 * @returns {Promise<unknown>}
 */
const deleteByQuoteType = async function (arg) {
    return new Promise((res, rej) => {
        logModel.deleteOne({...arg}, (err, data) => {
            if (err) {
                logSystem(err, 'error');
                rej(err)
                return
            }
            const resData = {dbCode: 200, msg: "数据删除成功!", data};
            res(resData);
            // logSystem(JSON.stringify(resData));
        });
    })
}

/**
 * 通过uuid属性查询多条删除数据
 * @param uuidList
 * @returns {Promise<unknown>}
 */
const deleteManyByUuid = async function (uuidList) {
    return new Promise((res, rej) => {
        logModel.deleteMany({'uuid': {$in: uuidList}}, (err, data) => {
            if (err) {
                logSystem(err, 'error');
                rej(err)
                return
            }
            const resData = {dbCode: 200, msg: "数据删除成功!", data};
            res(resData);
            // logSystem(JSON.stringify(resData));
        });
    })
}

/**
 * 通过对象属性查询数据(分页、多字段条件查询)
 * @param pageNum
 * @param pageSize
 * @param arg           过滤器
 * @returns {Promise<unknown>}
 */
const selectByQuoteType = async function (pageNum, pageSize, arg) {
    return new Promise((resolve, reject) => {
        logModel.find({...arg}).skip(pageNum * pageSize).limit(pageSize).exec((error, result) => {
            if (error) {
                logSystem(error, 'error');
                reject(error)
                return
            }
            const resData = {dbCode: 200, msg: "数据查询成功!", data: result};
            resolve(resData);
            // logSystem(JSON.stringify(resData));
        })
    })
}

/**
 * 查询count
 * @param arg
 * @returns {Promise<unknown>}
 */
const selectCount = function (arg) {
    return new Promise((resolve, reject) => {
        logModel.count({...arg}, (error, result) => {
            if (error) {
                logSystem(error, 'error');
                reject(error)
                return
            }
            const resData = {dbCode: 200, msg: "数据查询成功!", data: result};
            resolve(resData);
            // logSystem(JSON.stringify(resData));
        })
    })
}

/**
 * 添加多条数据
 * @param list
 * @returns {Promise<unknown>}
 */
const addMany = function (list) {
    return new Promise((res, rej) => {
        logModel.insertMany(list, (err, docs) => {
            if (err) {
                logSystem(err, 'error');
                rej(err)
                return
            }
            const resData = {dbCode: 200, msg: "数据批量插入成功!", docs};
            res(resData);
            // logSystem(JSON.stringify(resData));
        });
    })
}

/**
 * 删除当前文档的所有数据
 * @returns {Promise<unknown>}
 */
const deleteCurrentDoc = function () {
    return new Promise((res, rej) => {
        logModel.deleteMany({uuid: {$ne: "test"}}, function (err, docs) {
            if (err) {
                logSystem(err, 'error');
                rej(err)
                return
            }
            const resData = {dbCode: 200, msg: "清除文档成功!", docs};
            res(resData);
            // logSystem(JSON.stringify(resData));
        })
    })

}

module.exports = {
    add,
    addMany,
    deleteCurrentDoc,
    deleteByQuoteType,
    deleteManyByUuid,
    selectById,
    selectByQuoteType,
    selectCount
}
```

#### 路由层

```js
const router = require('koa-router')();
const logger = require("../control/logger");
router.prefix('/logs')
/**
 * 对路由表进行crud操作
 */

// 获取全部日志列表
router.post('/logList', async function (ctx, next) {
    /**
     * 可查询的条件       日期、方法、url、大屏使用方、ip、日志类型（系统、api、数据库操作）、日志等级、响应状态、响应速度
     */
    let {pageNum = 0, pageSize = 10, startTime, endTime, startSpeed, endSpeed} = ctx.request.body;
    let selJson = {}
    let reqBodyArgList = ['logType', 'logLevel', 'method', 'status']; // 多条件查询入参【可选】
    for (let i in reqBodyArgList) {
        ctx.request.body[reqBodyArgList[i]] ? selJson[reqBodyArgList[i]] = ctx.request.body[reqBodyArgList[i]] : ""
    }

    let like_Json = {}
    let like_reqBodyArgList = ['url', 'requestHref'] // 需要进行模糊查询的入参【可选】
    for (let i in like_reqBodyArgList) {
        ctx.request.body[like_reqBodyArgList[i]] ? like_Json[like_reqBodyArgList[i]] = new RegExp(`${ctx.request.body[like_reqBodyArgList[i]]}`) : ""
    }
    if (startTime && endTime) { // 日期范围查询【可选】
        selJson['startTime'] = {$gte: startTime, $lte: endTime}
    }
    if (startSpeed && endSpeed) { // 响应速度范围查询【可选】
        selJson['responseSpeed'] = {$gte: startSpeed, $lte: endSpeed}
    }


    const _filter = Object.assign(selJson, like_Json)
    let dataList = await logger.selectByQuoteType(pageNum, pageSize, _filter);
    let count = await logger.selectCount(_filter);
    return ctx.body = {code: 200, msg: "查询成功！", data: dataList.data, total: count.data, pageNum, pageSize}
})

// 删除指定日志
router.delete('/log', async function (ctx, next) {
    let {uuid} = ctx.request.body;
    if (!uuid) return ctx.body = {code: 204, msg: "入参错误，请查看接口文档！"};
    const _filter = {
        uuid
    }
    let dataList = await logger.deleteByQuoteType(_filter);
    if (dataList.data.deletedCount > 0) {
        return ctx.body = {code: 200, msg: "数据删除查询成功！", count: dataList.data.deletedCount}
    } else {
        return ctx.body = {code: 200, msg: "数据已被删除或者不存在！",}
    }
})
// 删除多条日志
router.delete('/logList', async function (ctx, next) {
    let {uuids} = ctx.request.body;
    if (!uuids) return ctx.body = {code: 204, msg: "入参错误，请查看接口文档！"};
    if (!Array.isArray(uuids)) return ctx.body = {code: 204, msg: "入参错误，请查看接口文档！"};

    let dataList = await logger.deleteManyByUuid(uuids);
    if (dataList.data.deletedCount > 0) {
        return ctx.body = {code: 200, msg: "数据删除查询成功！", count: dataList.data.deletedCount}
    } else {
        return ctx.body = {code: 200, msg: "数据已被删除或者不存在！",}
    }
})

// 删除日志文档
router.delete('/logDocument', async function (ctx, next) {
    let res = await logger.deleteCurrentDoc();
    ctx.body = res
})
module.exports = router
```



### 前端日志分析页面

```html
<html>

<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
    <script src="http://127.0.0.1:8689/cdn/Vue/vue@next.js"></script>
    <link rel="stylesheet" href="http://127.0.0.1:8689/cdn/element-plus/index.css">
    <link rel="stylesheet" href="http://127.0.0.1:8689/cdn/element-plus/index.js">
    <script src="http://127.0.0.1:8689/cdn/element-plus/index.js"></script>
    <!-- <script src="https://unpkg.com/element-plus"></script> -->
    <!-- <script type="text/javascript" src="http://127.0.0.1:8689/cdn/vs/loader.js"></script>
    <script type="text/javascript" src="http://127.0.0.1:8689/cdn/vs/basic-languages/sql/sql.js"></script> -->
    <title>日志分析</title>
    <style>
        body,
        html {
            margin: 0;
            padding: 0;
            font-size: 12px !important;
        }

        .el-table__body {
            font-size: 10px;
        }

        /*-------滚动条整体样式----*/
        .jsonPre::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        /*滚动条里面小方块样式*/
        .jsonPre::-webkit-scrollbar-thumb {
            border-radius: 100px;
            -webkit-box-shadow: inset 0 0 5px rgba(32, 83, 107, 0.92);
            background: rgba(160, 158, 177, 0.331);
        }

        /*边角*/
        .jsonPre::-webkit-scrollbar-corner {
            background: rgba(160, 158, 177, 0.331);
        }

        /*滚动条里面轨道样式*/
        .jsonPre::-webkit-scrollbar-track {
            -webkit-box-shadow: inset 0 0 5px rgba(32, 83, 107, 0.92);
            border-radius: 0;
            background: rgba(103, 102, 114, 0.331);
        }

        .jsonPre {
            background-color: #262629;
            color: #fff;
            width: 90%;
            max-height: 50vh;
            outline: 1px solid #ccc;
            padding: 5px;
            overflow: scroll;
            border-radius: 4px;
            position: relative;
        }

        .btn-pre-copy {
            position: absolute;
            right: 8px;
            top: 4px;
            color: #a5a59f;
            user-select: none;
        }

        .string {
            color: green;
        }

        .number {
            color: darkorange;
        }

        .boolean {
            color: blue;
        }

        .null {
            color: magenta;
        }

        .key {
            color: red;
        }
    </style>
</head>

<body>
<div id="app">
    <div class="common-layout">
        <el-container>
            <el-container>
                <el-main>
                    <el-form :model="form" label-width="120px">
                        <el-form-item label="请求地址来源">
                            <el-input v-model="form.requestHref"
                                      placeholder="支持模糊搜索,例如:    https://element-plus.org/zh-C"/>
                        </el-form-item>
                        <el-form-item label="接口地址">
                            <el-input v-model="form.url"
                                      placeholder="支持模糊搜索,例如:    /proxyApi/sgj/sbhzzb?pk=CAJFBW7GmOf"/>
                        </el-form-item>


                        <el-form-item label="请求类型">
                            <el-col :span="3">
                                <el-select v-model="form.method" placeholder="选择请求类型">
                                    <el-option v-for="item in methodOptions" :key="item.value" :label="item.label"
                                               :value="item.value" :disabled="item.disabled"/>
                                </el-select>
                            </el-col>
                            <el-col :span="5">
                                <el-form-item label="响应状态">
                                    <el-select v-model="form.status" placeholder="选择响应状态">
                                        <el-option v-for="item in statusOptions" :key="item.value"
                                                   :label="item.label" :value="item.value" :disabled="item.disabled"/>
                                    </el-select>
                                </el-form-item>
                            </el-col>

                            <el-col :span="5">
                                <el-form-item label="日志类型">
                                    <el-select v-model="form.logType" placeholder="选择日志类型">
                                        <el-option v-for="item in logTypeOptions" :key="item.value"
                                                   :label="item.label" :value="item.value" :disabled="item.disabled"/>
                                    </el-select>
                                </el-form-item>
                            </el-col>

                            <el-col :span="5">
                                <el-form-item label="日志等级">
                                    <el-select v-model="form.logLevel" placeholder="选择日志等级">
                                        <el-option v-for="item in logLevelOptions" :key="item.value"
                                                   :label="item.label" :value="item.value" :disabled="item.disabled"/>
                                    </el-select>
                                </el-form-item>
                            </el-col>
                        </el-form-item>


                        <el-form-item label="请求时间范围">
                            <el-col :span="4">
                                <el-date-picker v-model="form.startTime" type="datetime" placeholder="选择开始时间"
                                                style="width: 100%"/>
                            </el-col>
                            <el-col :span="1" class="text-center">

                            </el-col>
                            <el-col :span="4">
                                <el-date-picker v-model="form.endTime" type="datetime" placeholder="选择结束时间"
                                                style="width: 100%"/>
                            </el-col>
                        </el-form-item>
                        <el-form-item label="响应速度范围" label-width="120px">
                            <el-col :span="2">
                                <el-input-number v-model="form.startSpeed" :min="0"/>
                            </el-col>
                            <el-col :span="1" class="text-center"></el-col>
                            <el-col :span="2">
                                <el-input-number v-model="form.endSpeed" :min="1"/>
                            </el-col>
                        </el-form-item>
                        <el-form-item label-width="20px">
                            <el-button type="primary" @click="onSubmit">查询</el-button>
                            <el-button @click="onReset">重置</el-button>
                            <el-button type="danger" @click="onDelStorage">重置数据库中所有日志数据</el-button>
                        </el-form-item>
                    </el-form>


                    <!-- <el-table-v2 :columns="columns" :data="data" :estimated-row-height="50"
                        :expand-column-key="columns[0].key" :width="700" :height="400">
                        <template #row="props">
                            <Row v-bind="props" />
                        </template>
                    </el-table-v2> -->
                    <el-table :data="tableData" size="small" highlight-current-row="true" style="font-size: 10px"
                              stripe :border="true" max-height="450">
                        <el-table-column label="#" type="expand">
                            <template #default="props">
                                <div style="padding: 10px;">
                                    <template v-if="props.row.requestQuery">
                                        <p m="t-0 b-2">请求入参(Query):
                                        <div class="jsonPre">
                                            <span class="btn-pre-copy"
                                                  @click="onCodeCopy(props.row.requestQuery)">复制代码</span>
                                            <pre v-html='parse2(props.row.requestQuery)'></pre>
                                        </div>
                                        </p>
                                    </template>
                                    <template v-if="props.row.requestBody">
                                        <p m="t-0 b-2">请求入参(Body):
                                        <div class="jsonPre">
                                            <span class="btn-pre-copy" @click="onCodeCopy(props.row.requestBody)">复制代码</span>
                                            <pre v-html='parse2(props.row.requestBody)'></pre>
                                        </div>
                                        </p>
                                    </template>
                                    <template v-if="props.row.requestProxyOtiton">
                                        <p m="t-0 b-2">请求前缀(代理接口方):
                                        <div class="jsonPre">
                                            <span class="btn-pre-copy" @click="onCodeCopy(props.row.requestProxyOtiton)">复制代码</span>
                                            <pre v-html='parse2(props.row.requestProxyOtiton)'></pre>
                                        </div>
                                        </p>
                                    </template>
                                    <template v-if="props.row.data">
                                        <p m="t-0 b-2" v-if="props.row.data">msg: {{ props.row.data }}</p>
                                    </template>
                                    <template v-if="props.row.responseData">
                                        <p m="t-0 b-2">响应数据:
                                        <div class="jsonPre">
                                            <span class="btn-pre-copy" @click="onCodeCopy(props.row.responseData)">复制代码</span>
                                            <pre v-html='parse2(props.row.responseData)'></pre>
                                        </div>
                                        </p>
                                    </template>
                                    <template v-if="props.row.requestProxyData">
                                        <p m="t-0 b-2">响应数据(源):
                                        <div class="jsonPre">
                                            <span class="btn-pre-copy" @click="onCodeCopy(props.row.requestProxyData)">复制代码</span>
                                            <pre v-html='parse2(props.row.requestProxyData)'></pre>
                                        </div>
                                        </p>
                                    </template>
                                </div>
                            </template>
                        </el-table-column>
                        <el-table-column width="120" align="center" label="uuid" show-overflow-tooltip sortable
                                         prop="uuid">
                            <template #default="props">
                                <span>{{ props.row.uuid || '---' }}</span>
                            </template>
                        </el-table-column>
                        <el-table-column width="90" align="center" label="日志类型" show-overflow-tooltip
                                         prop="logType">
                            <template #default="props">
                                <span>{{  logTypeOptions.filter(i=>i.value==props.row.logType)[0].label || '---' }}</span>
                            </template>
                        </el-table-column>
                        <el-table-column width="90" align="center" label="日志等级" show-overflow-tooltip
                                         prop="logLevel">
                            <template #default="props">
                                <span>{{ props.row.logLevel || '---' }}</span>
                            </template>
                        </el-table-column>
                        <el-table-column width="90" align="center" label="请求方法" show-overflow-tooltip prop="method">
                            <template #default="props">
                                <span>{{ props.row.method || '---' }}</span>
                            </template>
                        </el-table-column>
                        <el-table-column width="120" align="center" label="响应状态" show-overflow-tooltip sortable
                                         prop="status">
                            <template #default="props">
                                <span>{{ props.row.status || '---' }}</span>
                            </template>
                        </el-table-column>
                        <el-table-column width="120" align="center" label="响应速度" show-overflow-tooltip sortable
                                         prop="responseSpeed">
                            <template #default="props">
                                <span>{{ props.row.responseSpeed ? props.row.responseSpeed + "ms" : '---' }}</span>
                            </template>
                        </el-table-column>
                        <el-table-column width="200" align="center" label="请求地址" show-overflow-tooltip sortable
                                         prop="url">
                            <template #default="props">
                                <span>{{ props.row.url || '---' }}</span>
                            </template>
                        </el-table-column>
                        <el-table-column width="200" align="center" label="请求来源(ip)" show-overflow-tooltip sortable
                                         prop="remoteAddress">
                            <template #default="props">
                                <span>{{ props.row.remoteAddress || '---' }}</span>
                            </template>
                        </el-table-column>
                        <el-table-column width="200" align="center" label="请求来源(href)" show-overflow-tooltip
                                         sortable prop="requestHref">
                            <template #default="props">
                                <span>{{ props.row.requestHref || '---' }}</span>
                            </template>
                        </el-table-column>
                        <el-table-column width="140" align="center" label="请求时间" show-overflow-tooltip sortable
                                         prop="startTime">
                            <template #default="props">
                                <span>{{ formatDate(props.row.startTime) || '---' }}</span>
                            </template>
                        </el-table-column>

                        <el-table-column width="260" align="center" label="操作"
                                         class-name="small-padding fixed-width">
                            <template #default="props">
                                <!-- <el-button class="filter-item" type="primary" @click="tableItemDetail(scope.row)">查看
                                </el-button> -->
                                <el-button class="filter-item" type="danger" @click="onDelTableItem(props.row)">删除
                                </el-button>
                            </template>
                        </el-table-column>

                    </el-table>

                    <el-pagination style="margin-top: 10px;" layout="total, sizes, prev, pager, next, jumper"
                                   :total="pagination.total" :page-sizes="[10, 20, 50, 100]"
                                   :currentPage="pagination.pageNum + 1" @size-change="onSizeChange"
                                   @current-change="onCurrentChange">
                    </el-pagination>
                </el-main>
            </el-container>
        </el-container>
    </div>


</div>
<!-- <script>
    require.config({ paths: { 'vs': 'http://127.0.0.1:8689/cdn/vs' } });
    require.config({ 'vs/nls': { availableLanguages: { '*': 'zh-cn' } } });
    require(['vs/editor/editor#jsonPre'], function () {
        var editor = monaco.editor.create(document.getElementById('container'), {
            value: 'SELECT * FROM myindex',
            language: 'sql',
            theme: 'vs-dark'
        });
    });
</script> -->
<script>
    const request = async function (url, data = {}, opt = {}) {
        url = "http://127.0.0.1:8689" + url
        try {
            const response = await fetch(url, Object.assign({
                method: 'POST', // *GET, POST, PUT, DELETE, etc.
                mode: 'no-cors', // no-cors, *cors, same-origin
                cache: 'no-cache', // *default, no-cache, reload, force-cache, only-if-cached
                credentials: 'same-origin', // include, *same-origin, omit
                headers: {
                    'Content-Type': 'application/json; charset=utf-8'
                },
                redirect: 'follow', // manual, *follow, error
                referrerPolicy: 'no-referrer', // no-referrer, *no-referrer-when-downgrade, origin, origin-when-cross-origin, same-origin, strict-origin, strict-origin-when-cross-origin, unsafe-url
                body: JSON.stringify(data) // body data type must match "Content-Type" header
            }, opt));
            // return response.body
            return response.json(); // parses JSON response into native JavaScript objects
        } catch (e) {
            console.log("fetch接口请求错误", e)
            return {msg: "请求失败！", code: 500}
        }
    }
    // 请求封装
    const Request = function (url, param, option) {
        return new Promise((resolve, reject) => {
            let opt = {
                method: 'POST'
            };
            opt = Object.assign(opt, option)
            const xhr = new XMLHttpRequest();
            xhr.onreadystatechange = function () {
                if (xhr.readyState == 4 && xhr.status == 200) {
                    var data = xhr.responseText		// 接收响应信息
                    resolve(JSON.parse(data))
                }
            }
            xhr.open(opt.method, "http://127.0.0.1:8689" + url, true)
            xhr.setRequestHeader('Content-type', 'application/json; charset=utf-8')	// 设置Content-type
            xhr.send(JSON.stringify(param))   //发送请求到服务器
        })
    }
    const returnResetFormData = function () {
        return {
            requestHref: '',
            url: '',
            method: '',
            status: '',
            logType: '',
            logLevel: '',
            startTime: '',
            endTime: '',
            startSpeed: 0,
            endSpeed: 1000,
        }
    }
    const App = {
        setup() {
            const {reactive, ref , getCurrentInstance } = Vue;

            /**
             * data
             * */
            let editor = reactive({
                aaa: ""
            })
            let form = reactive(returnResetFormData());
            let tableData = reactive([]);
            // 分页器数据
            let pagination = reactive({
                total: 10,
                pageNum: 0,
                pageSize: 10
            });


            /**
             * methods
             * */
            const onSubmit = async () => {
                Request('/logs/logList', Object.assign(pagination, form)).then(res => {
                    console.log('/logs/logList 响应数据：', res);
                    pagination.total = res.total
                    while (tableData.shift()) {

                    }
                    tableData.push(...res.data)
                    // 初始化编辑器，确保dom已经渲染
                    // editor.aaa = monaco.editor.create(document.getElementById('container'), {
                    //     value: 'SDGHSKDLGHLKDSJGKLDSJGKLSDJGLK', // 编辑器初始显示文字
                    //     language: 'sql',//语言支持自行查阅demo
                    //     automaticLayout: true,//自动布局
                    //     theme: 'vs-dark' //官方自带三种主题vs, hc-black, or vs-dark
                    // });
                });
            }
            const onReset = () => {
                let obj = returnResetFormData()
                for (let i in obj) form[i] = obj[i]
            }
            const onDelStorage = () => {
                ElementPlus.ElMessageBox.confirm('清空日志库是危险操作，是否进行此操作。', '危险', {
                        confirmButtonText: '确定',
                        cancelButtonText: '取消',
                        type: 'danger',
                    }
                ).then(() => {
                    Request('/logs/logDocument', {}, {method: "delete"}).then(res => {
                        console.log('/logs/logDocument 响应数据：', res);
                        if (res.dbCode == 200) {
                            ElementPlus.ElMessage({
                                message: res.msg,
                                type: 'success',
                            })
                            onSubmit()
                        }

                    });
                })
            }
            const onSizeChange = (number) => {
                pagination.pageSize = number;
                onSubmit();
            }
            const onCurrentChange = (number) => {
                pagination.pageNum = number - 1;
                onSubmit();
            }
            const formatDate = (data) => {
                const dt = new Date(data)
                return dt.getFullYear()
                    + '-' + (dt.getMonth() + 1 > 10 ? dt.getMonth() + 1 : "0" + (dt.getMonth() + 1))
                    + '-' + (dt.getDate() >= 10 ? dt.getDate() : "0" + dt.getDate())
                    + ' ' + (dt.getHours() >= 10 ? dt.getHours() : "0" + dt.getHours())
                    + ':' + (dt.getMinutes() >= 10 ? dt.getMinutes() : "0" + dt.getMinutes())
                    + ':' + (dt.getSeconds() >= 10 ? dt.getSeconds() : "0" + dt.getSeconds())
            }
            const onDelTableItem = function (data) {
                Request('/logs/log', {uuid: data.uuid}, {method: "delete"}).then(res => {
                    console.log('/logs/log 响应数据：', res);
                    ElementPlus.ElMessage({
                        message: '删除成功！',
                        type: 'success',
                    })
                    onSubmit()
                });
            }
            const onCodeCopy = function (data) {
                if (navigator.clipboard) {
                    // let _data = new DataTransfer();
                    // _data.items.add("text/plain", "data");
                    navigator.clipboard.writeText(JSON.stringify(data)).then(function () {
                        ElementPlus.ElMessage({
                            message: '内容已经复制到剪贴板！',
                            type: 'success',
                        })
                    }, function (e) {
                        ElementPlus.ElMessage({
                            message: '内容复制到剪贴板失败！',
                            type: 'danger',
                        })
                    });
                } else {
                    var textarea = document.createElement('textarea');
                    document.body.appendChild(textarea);
                    textarea.style.position = 'fixed';
                    textarea.style.clip = 'rect(0 0 0 0)';
                    textarea.style.top = '10px';
                    textarea.value = data;
                    textarea.select();
                    document.execCommand('copy', true);
                    document.body.removeChild(textarea);
                }
                // ElementPlus.ElMessage({
                //     message: '内容已经复制到剪贴板！',
                //     type: 'success',
                // })
            }
            // json格式美化
            const parse2 = (str) => {
                // 设置缩进为2个空格
                if (!str) return '---'
                str = JSON.stringify(JSON.parse(str), null, 2);
                str = str
                    .replace(/&/g, '&')
                    .replace(/</g, '<')
                    .replace(/>/g, '>');
                return str.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, function (match) {
                    var cls = 'number';
                    if (/^"/.test(match)) {
                        if (/:$/.test(match)) {
                            cls = 'key';
                        } else {
                            cls = 'string';
                        }
                    } else if (/true|false/.test(match)) {
                        cls = 'boolean';
                    } else if (/null/.test(match)) {
                        cls = 'null';
                    }
                    return '<span class="' + cls + '">' + match + '</span>';
                });
            }


            /**
             * otherOptions
             * */
            const methodOptions = [
                {value: 'GET', label: 'GET'},
                {value: 'POST', label: 'POST'},
                {value: 'DELETE', label: 'DELETE'},
                {value: 'PUT', label: 'PUT'},
                {value: 'HEAD', label: 'HEAD'}
            ]
            const statusOptions = [
                {value: '200', label: '200'},
                {value: '400', label: '400'},
                {value: '404', label: '404'},
                {value: '500', label: '500'}
            ]

            const logTypeOptions = [
                {value: 'apiLogger', label: '接口请求'},
                {value: 'systemLogger', label: '系统打印'},
            ]
            const logLevelOptions = [
                {value: 'INFO', label: 'INFO'},
                {value: 'ERROR', label: 'ERROR'},
            ]


            ElementPlus.ElMessage({
                message: 'Congrats, this is a success message.',
                type: 'success',
            })


            return {
                onSubmit,
                onReset,
                onDelStorage,
                onSizeChange,
                onCurrentChange,
                formatDate,
                onDelTableItem,
                onCodeCopy,
                parse2,
                form,
                methodOptions,
                statusOptions,
                logTypeOptions,
                logLevelOptions,


                pagination,
                tableData

            }
        },
    };
    const app = Vue.createApp(App);
    app.use(ElementPlus);
    app.mount("#app");


    // 流程 http 、session 、通信协议、
</script>
</body>

</html>
```

## 效果展示

### 本地存储文件形式

![](https://cdnforspeed.oss-cn-beijing.aliyuncs.com/Img/%E4%B8%AA%E4%BA%BA%E7%AC%94%E8%AE%B0%E5%9B%BE%E7%89%87/20220707144647.png)

![](https://cdnforspeed.oss-cn-beijing.aliyuncs.com/Img/%E4%B8%AA%E4%BA%BA%E7%AC%94%E8%AE%B0%E5%9B%BE%E7%89%87/20220707144701.png)

![](https://cdnforspeed.oss-cn-beijing.aliyuncs.com/Img/%E4%B8%AA%E4%BA%BA%E7%AC%94%E8%AE%B0%E5%9B%BE%E7%89%87/20220707144720.png)

### 数据库：

![](https://cdnforspeed.oss-cn-beijing.aliyuncs.com/Img/%E4%B8%AA%E4%BA%BA%E7%AC%94%E8%AE%B0%E5%9B%BE%E7%89%87/20220707143948.png)

### 前端页面：

![](https://cdnforspeed.oss-cn-beijing.aliyuncs.com/Img/%E4%B8%AA%E4%BA%BA%E7%AC%94%E8%AE%B0%E5%9B%BE%E7%89%87/20220707144111.png)

### 下转查看：

![](https://cdnforspeed.oss-cn-beijing.aliyuncs.com/Img/%E4%B8%AA%E4%BA%BA%E7%AC%94%E8%AE%B0%E5%9B%BE%E7%89%87/20220707144151.png)

### 代码可复制：

![](https://cdnforspeed.oss-cn-beijing.aliyuncs.com/Img/%E4%B8%AA%E4%BA%BA%E7%AC%94%E8%AE%B0%E5%9B%BE%E7%89%87/20220707144220.png)